{% for n in notes %}
<div class="card">
  <!-- Note content (visible by default, hidden when editing) -->
  <div id="note-content-{{ n.id }}" class="note-content">
    <!-- Note title (clickable headline) -->
    <div class="note-title">{{ n.title }}</div>

    <!-- Metadata tags (author, date, class as badges) -->
    <div class="note-meta">
      <span class="meta-tag"><i class="ph ph-user"></i> {{ n.author }}</span>
      <span class="meta-tag"><i class="ph ph-calendar"></i> {{ n.created.strftime('%Y-%m-%d %H:%M') }}</span>
      <span class="meta-tag"><i class="ph ph-book-open"></i> {{ n.class_code }}</span>
      <span class="meta-tag"><i class="ph-fill ph-heart" style="color: #ef4444;"></i> {{ n.likes|length }}</span>
      <span class="meta-tag"><i class="ph ph-chat-circle"></i> {{ n.comments|length }}</span>
      {# Tags badges on note (includes both form tags and body hashtags) #}
      {% if n.get_tags_list() %}
      {% for tag in n.get_tags_list() %}
      <a href="/?tag_filter={{ tag }}" class="meta-tag">#{{ tag }}</a>
      {% endfor %}
      {% endif %}
    </div>

    <!-- Note content/body -->
    <div class="note-body">{{ n.body }}</div>

    <!-- Attachments section (only show user-uploaded files, not auto-generated PDF page renders) -->
    {% set ns = namespace(visible_count=0) %}
    {% for attachment in n.attachments %}{% if not attachment.original_filename.startswith('__') %}{% set ns.visible_count = ns.visible_count + 1 %}{% endif %}{% endfor %}
    {% if ns.visible_count > 0 %}
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(102, 126, 234, 0.2);">
      <div style="font-size: 13px; font-weight: 600; color: #a0a3bd; margin-bottom: 8px;">
        <i class="ph ph-paperclip"></i> Attachments ({{ ns.visible_count }}):
      </div>
      <!-- List of downloadable attachments -->
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        {% for attachment in n.attachments if not attachment.original_filename.startswith('__') %}
        <!-- Each attachment as a download link with file type badge -->
        <a href="/download/{{ attachment.id }}" class="attachment-link">
          <!-- File type icon based on extension -->
          {% if attachment.file_type == 'pdf' %}<i class="ph ph-file-pdf"></i>
          {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}<i class="ph ph-image"></i>
          {% elif attachment.file_type in ['doc', 'docx'] %}<i class="ph ph-file-doc"></i>
          {% elif attachment.file_type in ['ppt', 'pptx'] %}<i class="ph ph-file-ppt"></i>
          {% else %}<i class="ph ph-paperclip"></i>
          {% endif %}
          <!-- Display original filename -->
          <span>{{ attachment.original_filename }}</span>
          <!-- Download icon -->
          <span style="opacity: 0.7;"><i class="ph ph-download-simple"></i></span>
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Edit form (hidden by default, shown when edit button is clicked) -->
  <div id="edit-form-{{ n.id }}" class="edit-form">
    <form method="POST" action="/edit/{{ n.id }}" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <!-- Title input for editing -->
      <div style="margin-bottom: 12px;">
        <input type="text" name="title" value="{{ n.title }}" placeholder="Note title" required style="width: 100%;">
      </div>

      <!-- Author is fixed and cannot be changed (shows current author) -->
      <div style="margin-bottom: 12px; color: #888; font-size: 14px;">
        Author: {{ n.author }}
      </div>

      <!-- Class selector for editing -->
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px;">Course</label>
        <div style="display: flex; gap: 12px;">
          <div class="course-select">
            <select id="edit-subject-{{ n.id }}" data-note-id="{{ n.id }}" class="edit-subject-select">
              <option value="">Subject</option>
              {% for subj in subjects %}
              <option value="{{ subj }}">{{ subj }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="course-select">
            <select id="edit-number-{{ n.id }}" class="edit-number-select">
              <option value="">Number</option>
            </select>
          </div>
          <input type="hidden" name="class" id="edit-class-hidden-{{ n.id }}" value="{{ n.class_code }}">
        </div>
      </div>

      <!-- Body textarea for editing -->
      <div style="margin-bottom: 12px;">
        <textarea name="body" placeholder="Note content" required
          style="width: 100%; min-height: 120px;">{{ n.body }}</textarea>
      </div>

      <!-- Tags input for editing (comma-separated) -->
      <div style="margin-bottom: 12px;">
        <input type="text" name="tags" value="{{ n.get_tags_list()|join(', ') }}" placeholder="tags (comma-separated)"
          style="width:100%;">
      </div>

      <!-- Existing attachments management -->
      {% if n.attachments %}
      <div style="margin-bottom: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
        <div style="font-size: 13px; font-weight: 600; color: #a0a3bd; margin-bottom: 8px;">
          <i class="ph ph-paperclip"></i> Existing Attachments:
        </div>
        {% for attachment in n.attachments %}
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <input type="checkbox" name="delete_attachments" value="{{ attachment.id }}" id="delete-{{ attachment.id }}">
          <label for="delete-{{ attachment.id }}" style="cursor: pointer; font-size: 13px; color: #e4e6eb;">
            {% if attachment.file_type == 'pdf' %}<i class="ph ph-file-pdf"></i>
            {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}<i class="ph ph-image"></i>
            {% elif attachment.file_type in ['doc', 'docx'] %}<i class="ph ph-file-doc"></i>
            {% elif attachment.file_type in ['ppt', 'pptx'] %}<i class="ph ph-file-ppt"></i>
            {% else %}<i class="ph ph-paperclip"></i>
            {% endif %}
            {{ attachment.original_filename }} <span style="color: #f44336;">(check to delete)</span>
          </label>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- New attachments upload -->
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px; font-weight: 600;">
          <i class="ph ph-paperclip"></i> Add New Attachments (optional)
        </label>
        <input type="file" name="attachments" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.txt,.ppt,.pptx"
          style="padding: 10px; background: rgba(23, 27, 46, 0.8); color: #e4e6eb; width: 100%;">
        <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
          Allowed: PDFs, Images, Documents â€¢ Max 16MB per file
        </div>
      </div>

      <!-- Action buttons for the edit form -->
      <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn-small btn-edit"><i class="ph ph-floppy-disk"></i> Save Changes</button>
        <button type="button" class="btn-small btn-cancel" onclick="toggleEdit('{{ n.id }}')"><i class="ph ph-x"></i>
          Cancel</button>
      </div>
    </form>
  </div>

  <!-- Action buttons section -->
  <div class="note-actions">
    <!-- Edit and Delete buttons - Only show if user is logged in AND (owns the note OR is an admin) -->
    {% if current_user is not none and (current_user.id == n.user_id or current_user.is_admin) %}
    <!-- Edit button - toggles the edit form -->
    <button class="btn-small btn-edit" onclick="toggleEdit('{{ n.id }}')"><i class="ph ph-pencil"></i> Edit</button>

    <!-- Delete button - removes the note -->
    <form method="POST" action="/delete/{{ n.id }}" style="display: inline;"
      onsubmit="return confirm('Are you sure you want to delete this note?');">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn-small btn-delete"><i class="ph ph-trash"></i> Delete</button>
    </form>
    {% endif %}

    <!-- Like button - available to all users -->
    <button type="button" class="like-button {% if n.id in user_liked_notes %}liked{% endif %}"
      onclick="toggleLike({{ n.id }}, this)" title="Like" style="margin-left:8px;">
      <i class="{% if n.id in user_liked_notes %}ph-fill{% else %}ph{% endif %} ph-heart"></i>
      <span class="like-count">{{ n.likes | length }}</span>
    </button>
  </div>

  <!-- Quick comment form (only for logged-in users) -->
  {% if current_user %}
  <div style="margin-top: 12px;">
    <form method="POST" action="/comment/{{ n.id }}" style="display:flex; gap:8px; align-items:center;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="text" name="comment_body" placeholder="Add a comment or @mention someone..."
        class="comment-input comment-body-input" required>
      <button type="submit" class="btn-small btn-edit"><i class="ph ph-chat-circle"></i> Post</button>
    </form>
  </div>
  {% else %}
  <div class="login-to-comment-banner">
    <span>
      <a href="/login">Log in</a> to comment
    </span>
  </div>
  {% endif %}
</div>
{% endfor %}