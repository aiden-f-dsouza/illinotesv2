<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Class Notes - Illinotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- External CSS System -->
  <link rel="stylesheet" href="{{ url_for('static', filename='turbolearn-darkmode.css') }}">

  <!-- Typography System -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Notes page specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='notes-page.css') }}">

  <!-- Choices.js for searchable dropdowns -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    /* Additional page-specific styles */
    body {
      padding-top: 70px;
      padding-bottom: 20px;
    }

    /* Container using theme system */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Navigation using new header styles */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--bg-overlay);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-light);
      z-index: 1000;
      padding: 0 20px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }

    .navbar-logo {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 800;
      color: var(--accent-terracotta);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .navbar-logo:hover {
      opacity: 0.8;
    }

    .navbar-nav {
      display: flex;
      gap: 24px;
      align-items: center;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .navbar-nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
    }

    .navbar-nav a:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }

    .navbar-user {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .navbar-user a {
      color: var(--accent-terracotta);
      text-decoration: none;
      font-weight: 600;
    }

    .navbar-user a:hover {
      opacity: 0.8;
    }

    /* Page title */
    .title {
      font-family: var(--font-serif);
      font-size: clamp(2rem, 4vw, 2.8rem);
      font-weight: 900;
      margin-bottom: 30px;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(16, 21, 34, 0.85);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-xl);
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      transform: scale(0.9);
      transition: transform 0.3s ease;
      z-index: 2001;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .modal-header h2 {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 900;
      color: var(--text-primary);
      margin: 0;
      letter-spacing: -0.02em;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 32px;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      line-height: 1;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 32px;
    }

    /* Navbar search bar */
    .navbar-search {
      flex: 1;
      max-width: 400px;
      margin: 0 20px;
    }

    .navbar-search input {
      width: 100%;
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .navbar-search input:focus {
      outline: none;
      border-color: var(--accent-terracotta);
      box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.1);
    }

    /* Add Note section - highlighted row */
    .add-note-section {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 20px 32px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
    }

    .add-note-section h3 {
      font-family: var(--font-sans);
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .add-note-btn {
      background: var(--accent-terracotta);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(237, 137, 54, 0.3);
    }

    .add-note-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
    }

    /* Scroll to top button - bottom left */
    .scroll-to-top {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 48px;
      height: 48px;
      background: var(--accent-terracotta);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scroll-to-top.visible {
      opacity: 1;
      visibility: visible;
    }

    .scroll-to-top:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    /* Responsive design */
    @media(max-width:768px) {
      .title { font-size: 32px; }
      .navbar-nav { display: none; }
      .navbar-search { display: none; }
      .filter-section { padding: 16px; }
      .card { padding: 20px; }
      .note-actions { flex-wrap: wrap; }

      .add-note-section {
        padding: 16px 20px;
      }

      .add-note-section h3 {
        font-size: 16px;
      }

      .scroll-to-top {
        bottom: 20px;
        left: 20px;
        width: 44px;
        height: 44px;
      }

      .modal-content {
        width: 95%;
        max-height: 90vh;
      }

      .modal-header {
        padding: 20px 24px;
      }

      .modal-header h2 {
        font-size: 20px;
      }

      .modal-body {
        padding: 24px;
      }
    }
  </style>

  <script>
    // ===== JAVASCRIPT FOR CREATE NOTE MODAL =====
    // Opens the create note modal with animation
    function openCreateModal() {
      {% if current_user is not none %}
        const modal = document.getElementById('createNoteModal');
        if (modal) {
          modal.classList.add('active');
          // Prevent body scroll when modal is open
          document.body.style.overflow = 'hidden';
        }
      {% else %}
        // Redirect to login with message for non-logged-in users
        window.location.href = "{{ url_for('login') }}?message=Please log in to create a note";
      {% endif %}
    }

    // Closes the create note modal with animation
    function closeCreateModal() {
      const modal = document.getElementById('createNoteModal');
      if (modal) {
        modal.classList.remove('active');
        // Restore body scroll when modal is closed
        document.body.style.overflow = '';
      }
    }

    // Close modal when pressing Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeCreateModal();
      }
    });
  </script>
</head>
<body>
  <!-- Hidden data for JavaScript -->
  <div id="page-data"
       style="display: none;"
       data-page="{{ page|default(1) }}"
       data-classes='{{ classes | tojson }}'
       data-courses-dict='{{ courses_dict | tojson }}'
       data-subjects='{{ subjects | tojson }}'
       data-selected-filter="{{ selected_filter or 'All' }}">
  </div>

  <!-- Navigation Header -->
  <nav class="navbar notes-navbar">
    <div class="navbar-left">
      <!-- Text Logo -->
      <a href="{{ url_for('home') }}" class="navbar-logo-text">
        illinotes
      </a>

      <!-- Search bar with icon -->
      <div class="navbar-search">
        <form method="get" action="/notes">
          <input type="hidden" name="class_filter" value="{{ selected_filter or 'All' }}">
          <input type="hidden" name="tag_filter" value="{{ tag_filter or 'All' }}">
          <input type="hidden" name="date_filter" value="{{ date_filter or 'All' }}">
          <input type="hidden" name="sort_by" value="{{ sort_by or 'recent' }}">

          <div class="search-input-wrapper">
            <i class="ph ph-magnifying-glass search-icon"></i>
            <input type="text" name="search" placeholder="Search notes or authors..."
                   value="{{ search_query or '' }}" class="search-input-field">
          </div>
        </form>
      </div>
    </div>

    <div class="navbar-right">
      <ul class="navbar-nav">
        <!-- Other Products dropdown -->
        <li class="nav-dropdown">
          <a href="#" class="dropdown-trigger">
            Other Products
            <i class="ph ph-caret-down"></i>
          </a>
          <div class="dropdown-menu">
            <a href="/summarizer">
              <i class="ph ph-sparkle"></i> AI Note Summarizer
            </a>
            <a href="/forum">
              <i class="ph ph-chat-circle"></i> Forum
            </a>
          </div>
        </li>

        <!-- User section with avatar dropdown -->
        {% if current_user is not none %}
          <li class="nav-dropdown user-dropdown">
            <a href="#" class="dropdown-trigger user-avatar-trigger">
              <div class="user-avatar">
                {{ current_user.email[0].upper() }}
              </div>
            </a>
            <div class="dropdown-menu user-dropdown-menu">
              <div class="dropdown-user-info">
                <div class="dropdown-user-email">{{ current_user.email }}</div>
              </div>
              <div class="dropdown-divider"></div>
              <a href="{{ url_for('profile') }}">
                <i class="ph ph-user"></i> Profile
              </a>
              <a href="{{ url_for('logout') }}" class="logout-link">
                <i class="ph ph-sign-out"></i> Logout
              </a>
            </div>
          </li>
        {% else %}
          <li><a href="{{ url_for('login') }}" class="btn-nav-login">Login</a></li>
          <li><a href="{{ url_for('signup') }}" class="btn-nav-signup">Sign Up</a></li>
        {% endif %}
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="title" style="margin-top: 10px;"><i class="ph-duotone ph-hand-waving" style="color: var(--accent-terracotta);"></i> Welcome to Illinotes, {{ current_user.display_name or current_user.username }}!</div>

    <!-- Notifications Banner for @Mentions -->
    {% if unread_mentions and unread_mentions|length > 0 %}
    <div style="background: linear-gradient(135deg, rgba(237, 137, 54, 0.15) 0%, rgba(237, 137, 54, 0.05) 100%); border: 2px solid var(--accent-terracotta); border-radius: var(--radius-lg); padding: 16px 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(237, 137, 54, 0.2);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
        <h3 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 700;">
          <i class="ph ph-bell"></i> You have {{ unread_mentions|length }} new mention{{ 's' if unread_mentions|length > 1 else '' }}
        </h3>
        <form method="POST" action="/mentions/mark-all-read" style="margin: 0;">
          <button type="submit" style="background: var(--accent-terracotta); color: white; border: none; padding: 6px 12px; border-radius: var(--radius-md); font-size: 12px; cursor: pointer; font-weight: 600;">
            Mark all as read
          </button>
        </form>
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        {% for mention in unread_mentions[:5] %}
        <a href="/notes#note-{{ mention.note_id }}" onclick="markMentionRead({{ mention.id }})" style="display: block; background: rgba(16, 21, 34, 0.6); padding: 12px; border-radius: 8px; border-left: 3px solid var(--accent-terracotta); text-decoration: none; transition: all 0.2s ease;">
          <div style="color: var(--text-primary); font-size: 14px; margin-bottom: 4px;">
            <strong style="color: var(--accent-terracotta);">{{ mention.mentioning_author }}</strong> mentioned you in a comment
          </div>
          <div style="color: var(--text-secondary); font-size: 12px;">
            {{ mention.created.strftime('%b %d, %Y at %H:%M') }}
          </div>
        </a>
        {% endfor %}
        {% if unread_mentions|length > 5 %}
        <div style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 4px;">
          ... and {{ unread_mentions|length - 5 }} more
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Add Note Section - Highlighted Row -->
    <div class="add-note-section">
      <h3><i class="ph ph-note-pencil"></i> Share Your Notes</h3>
      <button class="add-note-btn" onclick="openCreateModal()">Add Note +</button>
    </div>

    <!-- Find Your Course Section -->
    <div class="section-card">
      <h2 class="section-heading"><i class="ph ph-magnifying-glass"></i> Find Your Course</h2>
      <form method="get" action="/notes" id="course-filter-form">
        <!-- Hidden fields to preserve other filters -->
        <input type="hidden" name="search" value="{{ search_query or '' }}">
        <input type="hidden" name="tag_filter" value="{{ tag_filter or 'All' }}">
        <input type="hidden" name="date_filter" value="{{ date_filter or 'All' }}">
        <input type="hidden" name="sort_by" value="{{ sort_by or 'recent' }}">
        <input type="hidden" name="class_filter" id="class-filter-hidden" value="{{ selected_filter or 'All' }}">

        <div class="course-select-container">
          <div class="course-select">
            <select id="subject-select">
              <option value="">All Subjects</option>
            </select>
          </div>
          <div class="course-select">
            <select id="number-select">
              <option value="">All Numbers</option>
            </select>
          </div>
        </div>
      </form>
    </div>

    <!-- Posted Notes Section -->
    <div class="section-card">
      <div class="section-header-row">
        <h2 class="section-heading"><i class="ph ph-notebook"></i> Posted Notes</h2>

        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <!-- Note count -->
          <div class="note-count">{{ total }} notes</div>

          <!-- Date filter dropdown -->
          <form method="get" action="/notes" style="margin: 0;">
            <!-- Preserve current filters -->
            <input type="hidden" name="search" value="{{ search_query or '' }}">
            <input type="hidden" name="class_filter" value="{{ selected_filter or 'All' }}">
            <input type="hidden" name="tag_filter" value="{{ tag_filter or 'All' }}">
            <input type="hidden" name="sort_by" value="{{ sort_by or 'recent' }}">

            <select name="date_filter">
              <option value="All" {% if date_filter == "All" %}selected{% endif %}>All Time</option>
              <option value="Today" {% if date_filter == "Today" %}selected{% endif %}>Today</option>
              <option value="Week" {% if date_filter == "Week" %}selected{% endif %}>This Week</option>
              <option value="Month" {% if date_filter == "Month" %}selected{% endif %}>This Month</option>
            </select>
          </form>

          <!-- Sort dropdown - KEEP ALL OPTIONS including Most Liked, Most Commented, Popular -->
          <form method="get" action="/notes" style="margin: 0;">
            <!-- Preserve current filters -->
            <input type="hidden" name="search" value="{{ search_query or '' }}">
            <input type="hidden" name="class_filter" value="{{ selected_filter or 'All' }}">
            <input type="hidden" name="tag_filter" value="{{ tag_filter or 'All' }}">
            <input type="hidden" name="date_filter" value="{{ date_filter or 'All' }}">

            <select name="sort_by">
              <option value="recent" {% if sort_by == "recent" %}selected{% endif %}>Most Recent</option>
              <option value="oldest" {% if sort_by == "oldest" %}selected{% endif %}>Oldest First</option>
              <option value="title" {% if sort_by == "title" %}selected{% endif %}>Title (A-Z)</option>
              <option value="author" {% if sort_by == "author" %}selected{% endif %}>Author (A-Z)</option>
              <!-- IMPORTANT: Keep these extra options from index.html -->
              <option value="most_liked" {% if sort_by == "most_liked" %}selected{% endif %}>Most Liked</option>
              <option value="most_commented" {% if sort_by == "most_commented" %}selected{% endif %}>Most Commented</option>
              <option value="popular" {% if sort_by == "popular" %}selected{% endif %}>Top (Comments + Likes)</option>
            </select>
          </form>

          <!-- IMPORTANT: Keep the Top button from index.html -->
          <button type="button" class="btn-small btn-filter" style="margin-left:8px;" onclick="setPopularSort()"><i class="ph ph-star"></i> Top</button>

          <!-- Clear Filters button -->
          <button type="button" class="btn-small btn-filter" style="margin-left:8px;" onclick="resetFilters()"><i class="ph ph-x-circle"></i> Clear Filters</button>
        </div>
      </div>

      <!-- IMPORTANT: Keep the tag cloud from index.html -->
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        {% for tag, count in tags[:30] %}
          <a href="/notes?tag_filter={{ tag }}" class="meta-tag" style="text-decoration:none;">#{{ tag }} ({{ count }})</a>
        {% endfor %}
      </div>
    </div>

    <!-- Notes Feed -->
    <!-- Each note is displayed as a card with title, metadata, and content -->
    <div id="notes-feed" style="margin-top: 20px;">
    <div id="notes-container">
      {% for n in notes %}
      <div class="card" id="note-{{ n.id }}">
        <!-- Note content (visible by default, hidden when editing) -->
        <div id="note-content-{{ n.id }}" class="note-content">
          <!-- Note title (clickable headline) -->
          <div class="note-title">{{ n.title }}</div>

          <!-- Metadata tags (author, date, class as badges) -->
          <div class="note-meta">
            <span class="meta-tag"><i class="ph ph-user"></i> {{ n.author }}</span>
            <span class="meta-tag"><i class="ph ph-calendar"></i> {{ n.created.strftime('%Y-%m-%d %H:%M') }}</span>
            <span class="meta-tag"><i class="ph ph-book-open"></i> {{ n.class_code }}</span>
            <span class="meta-tag"><i class="ph-fill ph-heart" style="color: #ef4444;"></i> {{ n.likes|length }}</span>
            {# Tags badges on note (includes both form tags and body hashtags) #}
            {% if n.get_tags_list() %}
              {% for tag in n.get_tags_list() %}
                <a href="/notes?tag_filter={{ tag }}" class="meta-tag">#{{ tag }}</a>
              {% endfor %}
            {% endif %}
          </div>

          <!-- Note content/body -->
          <div class="note-body">{{ n.body }}</div>

          <!-- Attachments section (only show if note has attachments) -->
          {% if n.attachments %}
          <div class="attachments-container">
            <div class="attachments-title">
              <i class="ph ph-paperclip"></i> Attachments ({{ n.attachments|length }}):
            </div>
            <!-- List of downloadable attachments -->
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              {% for attachment in n.attachments %}
              <!-- Each attachment as a download link with file type badge -->
              <a href="/download/{{ attachment.id }}" class="attachment-link">
                <!-- File type icon based on extension -->
                {% if attachment.file_type == 'pdf' %}<i class="ph ph-file-pdf"></i>
                {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}<i class="ph ph-image"></i>
                {% elif attachment.file_type in ['doc', 'docx'] %}<i class="ph ph-file-doc"></i>
                {% elif attachment.file_type in ['ppt', 'pptx'] %}<i class="ph ph-file-ppt"></i>
                {% else %}<i class="ph ph-paperclip"></i>
                {% endif %}
                <!-- Display original filename -->
                <span>{{ attachment.original_filename }}</span>
                <!-- Download icon -->
                <span style="opacity: 0.7;"><i class="ph ph-download-simple"></i></span>
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Edit form (hidden by default, shown when edit button is clicked) -->
        <div id="edit-form-{{ n.id }}" class="edit-form">
          <form method="POST" action="/edit/{{ n.id }}" enctype="multipart/form-data">
            <!-- Title input for editing -->
            <div style="margin-bottom: 12px;">
              <input type="text" name="title" value="{{ n.title }}" placeholder="Note title" required style="width: 100%;">
            </div>

            <!-- Author is fixed and cannot be changed (shows current author) -->
            <div style="margin-bottom: 12px; color: #888; font-size: 14px;">
              Author: {{ n.author }}
            </div>

            <!-- Class selector for editing -->
            <div style="margin-bottom: 12px;">
              <select name="class" style="width: 100%;">
                {% for c in classes %}
                <option value="{{ c }}" {% if c == n.class_code %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Body textarea for editing -->
            <div style="margin-bottom: 12px;">
              <textarea name="body" placeholder="Note content" required style="width: 100%; min-height: 120px;">{{ n.body }}</textarea>
            </div>

            <!-- Tags input for editing (comma-separated) -->
            <div style="margin-bottom: 12px;">
              <input type="text" name="tags" value="{{ n.get_tags_list()|join(', ') }}" placeholder="tags (comma-separated)" style="width:100%;">
            </div>

            <!-- Existing attachments management -->
            {% if n.attachments %}
            <div style="margin-bottom: 12px; padding: 12px; background: var(--bg-paper-dark); border-radius: 8px;">
              <div class="attachments-title">
                <i class="ph ph-paperclip"></i> Existing Attachments:
              </div>
              {% for attachment in n.attachments %}
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                <input type="checkbox" name="delete_attachments" value="{{ attachment.id }}" id="delete-{{ attachment.id }}">
                <label for="delete-{{ attachment.id }}" style="cursor: pointer; font-size: 13px; color: var(--text-primary);">
                  {% if attachment.file_type == 'pdf' %}<i class="ph ph-file-pdf"></i>
                  {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}<i class="ph ph-image"></i>
                  {% elif attachment.file_type in ['doc', 'docx'] %}<i class="ph ph-file-doc"></i>
                  {% elif attachment.file_type in ['ppt', 'pptx'] %}<i class="ph ph-file-ppt"></i>
                  {% else %}<i class="ph ph-paperclip"></i>
                  {% endif %}
                  {{ attachment.original_filename }} <span style="color: #dc2626;">(check to delete)</span>
                </label>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- New attachments upload -->
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600;">
                <i class="ph ph-paperclip"></i> Add New Attachments (optional)
              </label>
              <input
                type="file"
                name="attachments"
                multiple
                accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.txt,.ppt,.pptx"
                style="padding: 10px; background: rgba(23, 27, 46, 0.8); color: #e4e6eb; width: 100%;">
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                Allowed: PDFs, Images, Documents • Max 16MB per file
              </div>
            </div>

            <!-- Action buttons for the edit form -->
            <div style="display: flex; gap: 10px;">
              <button type="submit" class="btn-small btn-edit"><i class="ph ph-floppy-disk"></i> Save Changes</button>
              <button type="button" class="btn-small btn-cancel" onclick="toggleEdit({{ n.id }})"><i class="ph ph-x"></i> Cancel</button>
            </div>
          </form>
        </div>

        <!-- Action buttons section -->
        <div class="note-actions">
          <!-- Edit and Delete buttons - Only show if user is logged in AND (owns the note OR is an admin) -->
          {% if current_user is not none and (current_user.id == n.user_id or current_user.is_admin) %}
            <!-- Edit button - toggles the edit form -->
            <button class="btn-small btn-edit" onclick="toggleEdit({{ n.id }})"><i class="ph ph-pencil"></i> Edit</button>

            <!-- Delete button - removes the note -->
            <button type="button" class="btn-small btn-delete" onclick="deleteNoteAjax({{ n.id }})">
              <i class="ph ph-trash"></i> Delete
            </button>
          {% endif %}

          <!-- Like button - available to all users -->
          <button type="button"
                  class="like-button {% if n.id in user_liked_notes %}liked{% endif %}"
                  onclick="toggleLike({{ n.id }}, this)"
                  title="Like"
                  style="margin-left:8px;">
            <i class="{% if n.id in user_liked_notes %}ph-fill{% else %}ph{% endif %} ph-heart"></i>
            <span class="like-count">{{ n.likes | length }}</span>
          </button>
        </div>

        <!-- Comments Thread Section -->
        {% if n.comments %}
        <div class="comments-container">
          <div class="comments-header">
            <div class="comments-title">
              <i class="ph ph-chat-circle"></i> Comments ({{ n.comments|length }})
            </div>
            <button onclick="toggleComments({{ n.id }})" class="comments-toggle-btn">
              <span class="toggle-text-{{ n.id }}">Hide comments</span>
            </button>
          </div>

          <div class="comments-list-{{ n.id }}">
            {% for comment in n.comments %}
          <div class="comment-item" id="comment-{{ comment.id }}">
            <div class="comment-header">
              <span class="comment-author">{{ comment.author }}</span>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="comment-date">{{ comment.created.strftime('%Y-%m-%d %H:%M') }}</span>
                {% if current_user and (comment.user_id == current_user.id or current_user.is_admin) %}
                  <button onclick="toggleEditComment({{ comment.id }})" class="btn-small comment-edit-btn"><i class="ph ph-pencil"></i> Edit</button>
                  <button onclick="deleteCommentAjax({{ comment.id }}, {{ n.id }})" class="btn-small comment-delete-btn"><i class="ph ph-trash"></i> Delete</button>
                {% endif %}
              </div>
            </div>

            <!-- Comment body (view mode) -->
            <div class="comment-view-{{ comment.id }} comment-body">{{ comment.body }}</div>

            <!-- Comment edit form (hidden by default) -->
            <div class="comment-edit-{{ comment.id }}" style="display: none;">
              <form onsubmit="editCommentAjax(event, {{ comment.id }})" style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                <input type="text" name="comment_body" value="{{ comment.body }}" class="comment-edit-input" required>
                <button type="submit" class="btn-small btn-edit" style="padding: 6px 12px; font-size: 12px;"><i class="ph ph-floppy-disk"></i> Save</button>
                <button type="button" onclick="toggleEditComment({{ comment.id }})" class="btn-small btn-cancel" style="padding: 6px 12px; font-size: 12px;"><i class="ph ph-x"></i> Cancel</button>
              </form>
            </div>
          </div>
          {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Quick comment form (only for logged-in users) -->
        {% if current_user %}
        <div style="margin-top: 12px;">
          <form onsubmit="addCommentAjax(event, this, {{ n.id }})" style="display:flex; gap:8px; align-items:center;">
            <input type="text" name="comment_body" placeholder="Add a comment or @mention someone..." class="comment-input comment-body-input" required>
            <button type="submit" class="btn-small btn-edit"><i class="ph ph-chat-circle"></i> Post</button>
          </form>
        </div>
        {% else %}
        <div style="margin-top: 12px; padding: 8px 12px; background: rgba(23,27,46,0.4); border-radius: 8px; text-align: center;">
          <span style="color: var(--text-secondary); font-size: 13px;">
            <a href="{{ url_for('login') }}" style="color: var(--accent-terracotta); text-decoration: none;">Log in</a> to comment
          </span>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    </div>

    {% if has_more %}
      <div style="text-align: center; margin: 20px 0;">
        <button id="load-more" class="btn-small btn-edit" onclick="loadMore()"><i class="ph ph-arrow-down"></i> Load More</button>
      </div>
    {% endif %}

    <!-- Empty state message when no notes match filters -->
    {% if notes|length == 0 %}
      <div class="empty-state">
        <div style="font-size: 48px; margin-bottom: 16px;"><i class="ph ph-package" style="font-size: 48px;"></i></div>
        <div>No notes found matching your filters.</div>
        <div style="font-size: 14px; margin-top: 8px;">Try adjusting your search or filters.</div>
      </div>
    {% endif %}

    <!-- Create Note Modal -->
    <!-- Modal popup for creating new notes - triggers from navbar button -->
    <!-- Only shown to logged-in users; anonymous users see login prompt in navbar -->
    {% if current_user is not none %}
    <div id="createNoteModal" class="modal">
      <!-- Dark backdrop - clicking it closes the modal -->
      <div class="modal-backdrop" onclick="closeCreateModal()"></div>

      <!-- Modal content container -->
      <div class="modal-content">
        <!-- Modal header with title and close button -->
        <div class="modal-header">
          <h2><i class="ph ph-pencil-simple-line"></i> Create New Note</h2>
          <button class="modal-close" onclick="closeCreateModal()" aria-label="Close modal">&times;</button>
        </div>

        <!-- Modal body with the create form -->
        <div class="modal-body">
          <!-- enctype="multipart/form-data" is REQUIRED for file uploads -->
          <form method="POST" action="/notes" enctype="multipart/form-data">
            <!-- Note title input (author is automatically set to logged-in user) -->
            <div>
              <input type="text" name="title" placeholder="Note title">
            </div>

            <!-- Class selector dropdown -->
            <div style="margin-top: 16px;">
              <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px; font-weight: 600;">
                <i class="ph ph-book-open"></i> Select Course
              </label>
              <div style="display: flex; gap: 12px;">
                <div class="course-select">
                  <select id="create-subject-select" name="subject">
                    <option value="">Subject</option>
                    {% for subj in subjects %}
                    <option value="{{ subj }}">{{ subj }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="course-select">
                  <select id="create-number-select" name="number">
                    <option value="">Number</option>
                  </select>
                </div>
                <input type="hidden" name="class" id="create-class-hidden" value="">
              </div>
            </div>

            <!-- Note content text area -->
            <div style="margin-top: 16px;">
              <textarea name="body" placeholder="Write your note..." required></textarea>
            </div>

            <!-- Tags input -->
            <div style="margin-top: 12px;">
              <input type="text" name="tags" placeholder="tags (comma-separated), e.g. exam, lecture">
            </div>

            <!-- File upload input -->
            <!-- The 'multiple' attribute allows users to select multiple files at once -->
            <div style="margin-top: 16px;">
              <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px; font-weight: 600;">
                <i class="ph ph-paperclip"></i> Attach Files (optional)
              </label>
              <input
                type="file"
                name="attachments"
                multiple
                accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.txt,.ppt,.pptx"
                style="padding: 10px; background: rgba(23, 27, 46, 0.8); color: #e4e6eb; width: 100%;">
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                Allowed: PDFs, Images (PNG, JPG, GIF), Documents (DOC, DOCX, TXT, PPT, PPTX) • Max 16MB per file
              </div>
            </div>

            <!-- Submit button (aligned to right) -->
            <div style="margin-top: 20px; text-align: right;">
              <button type="submit"><i class="ph ph-paper-plane-tilt"></i> Post Note</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Scroll to Top Button (Bottom Left) -->
  <button class="scroll-to-top" id="scrollToTopBtn" onclick="scrollToTop()" aria-label="Scroll to top">
    <i class="ph ph-arrow-up"></i>
  </button>

  <!-- Toast Container (Bottom Right) -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // Scroll to top function
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show/hide scroll-to-top button based on scroll position
    window.addEventListener('scroll', function() {
      const scrollBtn = document.getElementById('scrollToTopBtn');
      if (window.scrollY > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    });

    // Set popular sort (comments then likes) and submit the filter form
    function setPopularSort() {
      const select = document.querySelector('select[name="sort_by"]');
      if (select) {
        select.value = 'popular';
        select.form.submit();
      }
    }

    // Reset all filters to default values
    function resetFilters() {
      // Redirect to /notes with no query parameters (all default filters)
      window.location.href = '/notes';
    }

    // Mark a specific mention as read
    async function markMentionRead(mentionId) {
      try {
        await fetch(`/mentions/${mentionId}/mark-read`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
      } catch (err) {
        console.error('Failed to mark mention as read', err);
      }
    }

    // Toggle edit mode for a comment
    function toggleEditComment(commentId) {
      const viewDiv = document.querySelector(`.comment-view-${commentId}`);
      const editDiv = document.querySelector(`.comment-edit-${commentId}`);

      if (viewDiv.style.display === 'none') {
        // Currently editing - switch back to view mode
        viewDiv.style.display = 'block';
        editDiv.style.display = 'none';
      } else {
        // Currently viewing - switch to edit mode
        viewDiv.style.display = 'none';
        editDiv.style.display = 'block';
      }
    }

    // Toggle show/hide comments for a note
    function toggleComments(noteId) {
      const commentsList = document.querySelector(`.comments-list-${noteId}`);
      const toggleText = document.querySelector(`.toggle-text-${noteId}`);

      if (commentsList.style.display === 'none') {
        // Currently hidden - show comments
        commentsList.style.display = 'block';
        toggleText.textContent = 'Hide comments';
      } else {
        // Currently visible - hide comments
        commentsList.style.display = 'none';
        toggleText.textContent = 'Show comments';
      }
    }
  </script>

  <!-- Theme toggle script -->
  <script src="{{ url_for('static', filename='theme-toggle.js') }}"></script>

  <!-- Notes page JavaScript for dropdown logic -->
  <script src="{{ url_for('static', filename='notes-page.js') }}"></script>
  </body>
</html>
